// Generated by CoffeeScript 1.6.2
(function() {
  var Config, blindUp, createDeck, dealPlayersHands, gameStart, getInfo, intervalTime, join, level, playersCount, shuffleArray, state, structure, tables;

  Config = require('../config');

  tables = {};

  playersCount = 0;

  structure = Config.getStructure();

  intervalTime = Config.getIntervalTime();

  state = 'waiting';

  level = 0;

  join = function(name, key) {
    if (!tables[0] || tables[0].players.length < 10) {
      if (!tables[0]) {
        tables[0] = {};
      }
      if (!tables[0].players) {
        tables[0].players = [];
      }
      tables[0].players[playersCount] = {
        id: playersCount,
        name: name,
        key: key,
        isActive: false,
        win: null,
        tie: null,
        hand: []
      };
    }
    playersCount += 1;
    return console.log('join called!');
  };

  getInfo = function() {
    var info, key, value;

    info = {
      state: state,
      level: level,
      tables: {}
    };
    for (key in tables) {
      value = tables[key];
      info.tables[key] = {
        players: tables[key].players
      };
    }
    return info;
  };

  gameStart = function() {
    var key, value;

    state = 'gaming';
    level = 0;
    for (key in tables) {
      value = tables[key];
      dealPlayersHands(key);
    }
    return setTimeout(function() {
      return blindUp();
    }, intervalTime);
  };

  module.exports = {
    join: join,
    getInfo: getInfo,
    gameStart: gameStart
  };

  blindUp = function() {
    level += 1;
    return setTimeout(function() {
      return blindUp();
    }, intervalTime);
  };

  dealPlayersHands = function(tableId) {
    var cardPosition, i, key, value, _i, _ref;

    tables[tableId].deck = [].concat(createDeck());
    for (i = _i = 0; _i < 2; i = ++_i) {
      _ref = tables[tableId].players;
      for (key in _ref) {
        value = _ref[key];
        cardPosition = Math.floor(Math.random() * tables[tableId].deck.length);
        tables[tableId].players[key].hand[i] = tables[tableId].deck[cardPosition];
        tables[tableId].deck.splice(cardPosition, 1);
        tables[tableId].players[key].isActive = true;
      }
    }
    return console.log('check it!');
  };

  createDeck = function() {
    var trumps;

    trumps = ['As', '2s', '3s', '4s', '5s', '6s', '7s', '8s', '9s', 'Ts', 'Js', 'Qs', 'Ks', 'Ah', '2h', '3h', '4h', '5h', '6h', '7h', '8h', '9h', 'Th', 'Jh', 'Qh', 'Kh', 'Ad', '2d', '3d', '4d', '5d', '6d', '7d', '8d', '9d', 'Td', 'Jd', 'Qd', 'Kd', 'Ac', '2c', '3c', '4c', '5c', '6c', '7c', '8c', '9c', 'Tc', 'Jc', 'Qc', 'Kc'];
    return shuffleArray(trumps);
  };

  shuffleArray = function(trumps) {
    var j, key, length, t, value;

    length = trumps.length;
    for (key in trumps) {
      value = trumps[key];
      j = Math.floor(Math.random() * length);
      t = value;
      trumps[j] = value;
      trumps[key] = t;
    }
    return trumps;
  };

}).call(this);
